{% extends 'base.html' %}

{% block title %}Criar Viagem{% endblock %}

{% block content %}
<div class="container">
    <h2 class="page-title">Criar Nova Viagem</h2>

    <form id="create-trip-form" class="form-container" style="max-width: 90%;">
        {% csrf_token %}

        <!-- Depot ID should be passed from context or URL -->
        <input type="hidden" id="depot-id" value="{{ depot_id }}">

        <div class="form-group">
            <label>Selecionar Pedidos Pendentes:</label>
            <p class="category-specs">Clique nos cartões para selecionar os pedidos.</p>

            <!-- Container for selectable order cards -->
            <div id="orders-container" class="places-cards" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-top: 10px;">
                <p>Carregando pedidos pendentes...</p>
            </div>

            <div style="margin-top: 15px; padding: 10px; background: #e4e4e5; border-radius: 5px; display: flex; justify-content: space-around;">
                <span><strong>Selecionados:</strong> <span id="selected-count">0</span></span>
                <span><strong>Peso Total:</strong> <span id="selected-weight">0.00</span> kg</span>
                <span><strong>Volume Total:</strong> <span id="selected-volume">0.00</span> m³</span>
            </div>
        </div>

        <button type="submit" class="red-btn" style="margin-top: 20px;">Criar Viagem</button>
        <a href="/dashboard" id="back-link" class="switch-form-link" style="text-align: center; margin-top: 10px; display: block;">Voltar para Dashboard</a>
    </form>
</div>

<style>
    /* Specific styles for selectable cards */
    .selectable-card {
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
        background-color: #fff;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    }

    .selectable-card:hover {
        transform: translateY(-2px);
        box-shadow: 2px 4px 8px rgba(0,0,0,0.15);
    }

    .selectable-card.selected {
        border-color: var(--dark-red);
        background-color: #ffe6e6;
    }

    .selectable-card h3 {
        font-size: 1.1em;
        color: #333;
    }

    .selectable-card p {
        font-size: 0.9em;
        margin: 2px 0;
    }
</style>

<script>
    const depotId = "{{ place_id|escapejs }}";
    const truckSelect = document.getElementById('truck-select');
    const ordersContainer = document.getElementById('orders-container');
    const createTripForm = document.getElementById('create-trip-form');
    const backLink = document.getElementById('back-link');

    // Summary elements
    const selectedCountEl = document.getElementById('selected-count');
    const selectedWeightEl = document.getElementById('selected-weight');
    const selectedVolumeEl = document.getElementById('selected-volume');

    let selectedOrders = new Set();
    let ordersData = {}; // Map to store order details for calculation

    if (depotId) {
        backLink.href = `/depot/${depotId}`; // Or store/${depotId} depending on view
    }

    // Fetch Trucks
    async function loadTrucks() {
        try {
            const res = await fetch('/api/trucks');
            const data = await res.json();

            if (!res.ok) throw new Error(data.error || "Erro ao buscar caminhões");

            truckSelect.innerHTML = '<option value="">Selecione um caminhão...</option>';

            const trucks = data.data || [];
            trucks.forEach(truck => {
                // Ideally filter for available trucks (is_active=False or based on business logic)
                // Assuming API returns all, user picks.
                const option = document.createElement('option');
                option.value = truck.plate; // Or truck.id if endpoint expects ID. TruckCrud.create uses plate? No, DefineTrip likely uses ID or Plate.
                // Checking create_trip view/logic would be good. Assuming Truck ID is safer usually, or Plate if unique.
                // Let's use ID if available, or Plate. Truck model has ID.
                // Wait, TruckCrud.read returns objects. API usually serializes them.
                // Let's assume ID for relation.
                option.value = truck.id;
                option.textContent = `${truck.plate} - ${truck.model || 'Caminhão'} (${truck.max_payload_kg}kg)`;
                truckSelect.appendChild(option);
            });

        } catch (err) {
            console.error(err);
            truckSelect.innerHTML = '<option value="">Erro ao carregar caminhões</option>';
        }
    }

    // Fetch Pendent Orders
    async function loadPendentOrders() {
        try {
            const res = await fetch('/api/pendent-orders');
            const data = await res.json();

            if (!res.ok) throw new Error(data.error || "Erro ao buscar pedidos");

            ordersContainer.innerHTML = '';
            const orders = data.data || [];

            if (orders.length === 0) {
                ordersContainer.innerHTML = '<p>Não há pedidos pendentes.</p>';
                return;
            }

            orders.forEach(order => {
                ordersData[order.id] = order; // Store for calculations

                const card = document.createElement('div');
                card.className = 'selectable-card';
                card.dataset.id = order.id;
                card.innerHTML = `
                    <h3>Pedido #${order.id}</h3>
                    <p>Loja ID: ${order.store_id}</p>
                    <p>Peso: ${order.total_weight_kg} kg</p>
                    <p>Vol: ${parseFloat(order.total_volume_m3).toFixed(2)} m³</p>
                    <p>Caixas: ${order.total_boxes}</p>
                `;

                card.addEventListener('click', () => toggleOrderSelection(card, order.id));
                ordersContainer.appendChild(card);
            });

        } catch (err) {
            console.error(err);
            ordersContainer.innerHTML = '<p>Erro ao carregar pedidos.</p>';
        }
    }

    function toggleOrderSelection(card, orderId) {
        if (selectedOrders.has(orderId)) {
            selectedOrders.delete(orderId);
            card.classList.remove('selected');
        } else {
            selectedOrders.add(orderId);
            card.classList.add('selected');
        }
        updateSummary();
    }

    function updateSummary() {
        let totalWeight = 0;
        let totalVolume = 0;

        selectedOrders.forEach(id => {
            const order = ordersData[id];
            if (order) {
                totalWeight += order.total_weight_kg;
                totalVolume += parseFloat(order.total_volume_m3);
            }
        });

        selectedCountEl.textContent = selectedOrders.size;
        selectedWeightEl.textContent = totalWeight.toFixed(2);
        selectedVolumeEl.textContent = totalVolume.toFixed(2);
    }

    createTripForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (selectedOrders.size === 0) {
            alert("Por favor, selecione pelo menos um pedido.");
            return;
        }

        const payload = {
            depot_id: depotId, // Ensure integer if backend expects it
            orders: Array.from(selectedOrders)
        };

        try {
            // Using the DefineTripAPIView endpoint: api/depots/<id>/define-trip
            const res = await fetch(`/api/depot/${depotId}/define-trip`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            const result = await res.json();

            if (!res.ok) {
                throw new Error(result.error || "Erro ao criar viagem.");
            }

            alert("Viagem criada com sucesso!");
            window.location.href = backLink.href;

        } catch (err) {
            alert(err.message);
        }
    });

    // Initial Load
    window.addEventListener('load', () => {
        if (!depotId) {
            alert("ID do depósito não encontrado. Verifique se você acessou esta página corretamente.");
        }
        loadPendentOrders();
    });

</script>
{% endblock %}
